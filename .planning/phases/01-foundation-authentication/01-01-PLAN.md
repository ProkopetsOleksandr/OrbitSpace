---
phase: 01-foundation-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dotnet-web-api/OrbitSpace.Domain/Entities/User.cs
  - dotnet-web-api/OrbitSpace.Domain/Entities/RefreshToken.cs
  - dotnet-web-api/OrbitSpace.Application/Common/Interfaces/ITokenService.cs
  - dotnet-web-api/OrbitSpace.Application/Common/Interfaces/IRefreshTokenRepository.cs
  - dotnet-web-api/OrbitSpace.Application/Common/Models/OperationResult.cs
  - dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/LoginRequestDto.cs
  - dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/LoginResponseDto.cs
  - dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/RegisterRequestDto.cs
  - dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/RefreshRequestDto.cs
  - dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/RefreshResponseDto.cs
  - dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/RevokeRequestDto.cs
  - dotnet-web-api/OrbitSpace.Application/Dtos/UserDto.cs
  - dotnet-web-api/OrbitSpace.Application/Services/Interfaces/IAuthenticationService.cs
  - dotnet-web-api/OrbitSpace.Application/Services/AuthenticationService.cs
  - dotnet-web-api/OrbitSpace.Infrastructure/Persistence/AppDbContext.cs
  - dotnet-web-api/OrbitSpace.Infrastructure/Persistence/Configurations/UserConfiguration.cs
  - dotnet-web-api/OrbitSpace.Infrastructure/Persistence/Configurations/RefreshTokenConfiguration.cs
  - dotnet-web-api/OrbitSpace.Infrastructure/Persistence/Repositories/RefreshTokenRepository.cs
  - dotnet-web-api/OrbitSpace.Infrastructure/Services/JwtTokenService.cs
  - dotnet-web-api/OrbitSpace.Infrastructure/DependencyInjection.cs
autonomous: true

must_haves:
  truths:
    - "Backend can register a user with email, password, name, date of birth"
    - "Backend can authenticate a user and return access token + refresh token"
    - "Backend can validate a refresh token and issue new token pair (rotation)"
    - "Backend can revoke a refresh token (logout)"
    - "Refresh tokens are stored hashed (SHA256) in database"
    - "Access tokens expire in 15 minutes"
  artifacts:
    - path: "dotnet-web-api/OrbitSpace.Domain/Entities/RefreshToken.cs"
      provides: "RefreshToken entity with rotation and revocation support"
      contains: "class RefreshToken"
    - path: "dotnet-web-api/OrbitSpace.Infrastructure/Persistence/Repositories/RefreshTokenRepository.cs"
      provides: "Refresh token CRUD operations"
      contains: "class RefreshTokenRepository"
    - path: "dotnet-web-api/OrbitSpace.Infrastructure/Services/JwtTokenService.cs"
      provides: "Access token generation (15min), refresh token generation, hashing, validation"
      contains: "GenerateRefreshToken"
  key_links:
    - from: "OrbitSpace.Application/Services/AuthenticationService.cs"
      to: "OrbitSpace.Application/Common/Interfaces/ITokenService.cs"
      via: "dependency injection"
      pattern: "ITokenService"
    - from: "OrbitSpace.Infrastructure/Services/JwtTokenService.cs"
      to: "OrbitSpace.Infrastructure/Persistence/Repositories/RefreshTokenRepository.cs"
      via: "IRefreshTokenRepository for token persistence"
      pattern: "IRefreshTokenRepository"
---

<objective>
Build the complete backend authentication foundation: RefreshToken entity, enhanced token service with refresh token generation/rotation/revocation, updated authentication service with login (returning both tokens), register (with DateOfBirth), refresh, and revoke flows, plus the database migration.

Purpose: The backend must issue and manage access + refresh tokens before the frontend can implement cookie-based auth. This is the foundation everything else depends on.
Output: Fully functional backend auth endpoints ready for integration testing.
</objective>

<execution_context>
@C:/Users/Александр/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Александр/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.claude/rules/Next.js 16 + .NET API production-ready JWT architecture guide.md

Key existing files to read before modifying:
@dotnet-web-api/OrbitSpace.Domain/Entities/User.cs
@dotnet-web-api/OrbitSpace.Application/Common/Interfaces/ITokenService.cs
@dotnet-web-api/OrbitSpace.Application/Services/AuthenticationService.cs
@dotnet-web-api/OrbitSpace.Application/Services/Interfaces/IAuthenticationService.cs
@dotnet-web-api/OrbitSpace.Application/Common/Models/OperationResult.cs
@dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/LoginResponseDto.cs
@dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/RegisterRequestDto.cs
@dotnet-web-api/OrbitSpace.Application/Dtos/UserDto.cs
@dotnet-web-api/OrbitSpace.Infrastructure/Services/JwtTokenService.cs
@dotnet-web-api/OrbitSpace.Infrastructure/Persistence/AppDbContext.cs
@dotnet-web-api/OrbitSpace.Infrastructure/DependencyInjection.cs
@dotnet-web-api/OrbitSpace.Infrastructure/Persistence/Configurations/UserConfiguration.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RefreshToken entity, update User entity, add DTOs and interfaces</name>
  <files>
    dotnet-web-api/OrbitSpace.Domain/Entities/RefreshToken.cs
    dotnet-web-api/OrbitSpace.Domain/Entities/User.cs
    dotnet-web-api/OrbitSpace.Application/Common/Interfaces/ITokenService.cs
    dotnet-web-api/OrbitSpace.Application/Common/Interfaces/IRefreshTokenRepository.cs
    dotnet-web-api/OrbitSpace.Application/Common/Models/OperationResult.cs
    dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/LoginRequestDto.cs
    dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/LoginResponseDto.cs
    dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/RegisterRequestDto.cs
    dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/RefreshRequestDto.cs
    dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/RefreshResponseDto.cs
    dotnet-web-api/OrbitSpace.Application/Dtos/Authentication/RevokeRequestDto.cs
    dotnet-web-api/OrbitSpace.Application/Dtos/UserDto.cs
    dotnet-web-api/OrbitSpace.Application/Services/Interfaces/IAuthenticationService.cs
  </files>
  <action>
    **1. Create RefreshToken entity** (`OrbitSpace.Domain/Entities/RefreshToken.cs`):
    - Fields: `Id` (Guid), `UserId` (Guid), `Token` (string, required — stores SHA256 hash), `CreatedAtUtc` (DateTime), `ExpiresAtUtc` (DateTime), `RevokedAtUtc` (DateTime?, nullable), `UsedAtUtc` (DateTime?, nullable), `ReplacedByToken` (string?, nullable — for rotation audit trail), `DeviceInfo` (string?, nullable — User-Agent for session identification)
    - Computed properties: `IsRevoked => RevokedAtUtc.HasValue`, `IsExpired => DateTime.UtcNow >= ExpiresAtUtc`, `IsActive => !IsRevoked && !IsExpired && !UsedAtUtc.HasValue`
    - Navigation property: `User User { get; set; } = null!;`

    **2. Update User entity** (`OrbitSpace.Domain/Entities/User.cs`):
    - Add fields: `DateOfBirth` (DateTime), `EmailVerified` (bool, default false), `EmailVerificationToken` (string?, nullable), `CreatedAtUtc` (DateTime), `UpdatedAtUtc` (DateTime)
    - Add navigation: `ICollection<RefreshToken> RefreshTokens { get; set; } = new List<RefreshToken>();`

    **3. Update ITokenService** — add methods:
    - `string GenerateRefreshToken();` — generates cryptographically random 64-byte base64 string
    - `string HashToken(string token);` — SHA256 hash for storage

    **4. Create IRefreshTokenRepository** interface:
    - `Task CreateAsync(RefreshToken refreshToken)`
    - `Task<RefreshToken?> GetByTokenAsync(string hashedToken)` — include User navigation
    - `Task<List<RefreshToken>> GetActiveByUserIdAsync(Guid userId)`
    - `Task RevokeByTokenAsync(string hashedToken)` — sets RevokedAtUtc
    - `Task RevokeAllByUserIdAsync(Guid userId)` — revokes all non-revoked tokens
    - `Task SaveChangesAsync()` — for updating token fields after validation

    **5. Create/update DTOs:**
    - Create `LoginRequestDto` record: `(string Email, string Password, bool RememberMe, string? DeviceInfo)`
    - Update `LoginResponseDto` record: `(string AccessToken, string RefreshToken, UserDto User)` — add RefreshToken field
    - Update `RegisterRequestDto` record: `(string Email, string FirstName, string LastName, string Password, DateTime DateOfBirth)` — add DateOfBirth
    - Create `RefreshRequestDto` record: `(string RefreshToken)`
    - Create `RefreshResponseDto` record: `(string AccessToken, string RefreshToken)`
    - Create `RevokeRequestDto` record: `(string RefreshToken)`
    - Update `UserDto`: add `DateOfBirth` (DateTime), `EmailVerified` (bool) fields. Change `Id` from `Guid?` to `Guid`.

    **6. Update IAuthenticationService** interface — add:
    - Change `LoginAsync` signature from `(string email, string password)` to `(LoginRequestDto request)`
    - Add `Task<OperationResult<RefreshResponseDto>> RefreshAsync(RefreshRequestDto request)`
    - Add `Task<OperationResult> RevokeAsync(RevokeRequestDto request)`
    - Add `Task<OperationResult> RevokeAllAsync(Guid userId)`

    **7. Add Unauthorized error type to OperationResult:**
    - Uncomment `Unauthorized` in `OperationResultErrorType` enum (value 3)
    - Uncomment `Unauthorized` static factory method in `OperationResultError`
  </action>
  <verify>
    Run `dotnet build dotnet-web-api/OrbitSpace.Domain` and `dotnet build dotnet-web-api/OrbitSpace.Application` — both must compile without errors. Note: full solution won't build yet because Infrastructure/WebApi need updates in Task 2.
  </verify>
  <done>
    RefreshToken entity exists with all fields. User entity has DateOfBirth, timestamps, email verification fields. All DTOs created/updated. ITokenService has refresh token methods. IRefreshTokenRepository interface defined. IAuthenticationService has refresh/revoke methods. OperationResult supports Unauthorized error type.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement token service, repository, auth service, and database migration</name>
  <files>
    dotnet-web-api/OrbitSpace.Infrastructure/Services/JwtTokenService.cs
    dotnet-web-api/OrbitSpace.Infrastructure/Persistence/Repositories/RefreshTokenRepository.cs
    dotnet-web-api/OrbitSpace.Infrastructure/Persistence/AppDbContext.cs
    dotnet-web-api/OrbitSpace.Infrastructure/Persistence/Configurations/UserConfiguration.cs
    dotnet-web-api/OrbitSpace.Infrastructure/Persistence/Configurations/RefreshTokenConfiguration.cs
    dotnet-web-api/OrbitSpace.Infrastructure/DependencyInjection.cs
    dotnet-web-api/OrbitSpace.Application/Services/AuthenticationService.cs
  </files>
  <action>
    **1. Enhance JwtTokenService** (`OrbitSpace.Infrastructure/Services/JwtTokenService.cs`):
    - Change access token expiration from `AddDays(7)` to `AddMinutes(15)` — this is critical for security
    - Add `GenerateRefreshToken()` method: use `RandomNumberGenerator.Create()`, generate 64 random bytes, return `Convert.ToBase64String(randomBytes)`
    - Add `HashToken(string token)` method: SHA256 hash, return base64 string. Use `System.Security.Cryptography.SHA256`

    **2. Create RefreshTokenRepository** (`OrbitSpace.Infrastructure/Persistence/Repositories/RefreshTokenRepository.cs`):
    - Inject `AppDbContext`
    - `CreateAsync`: Add to context, SaveChangesAsync
    - `GetByTokenAsync(string hashedToken)`: FirstOrDefaultAsync with `.Include(rt => rt.User)` where `Token == hashedToken`
    - `GetActiveByUserIdAsync(Guid userId)`: Where UserId matches AND RevokedAtUtc is null AND UsedAtUtc is null AND ExpiresAtUtc > UtcNow, OrderByDescending CreatedAtUtc
    - `RevokeByTokenAsync(string hashedToken)`: Find by token, set RevokedAtUtc = UtcNow, SaveChanges
    - `RevokeAllByUserIdAsync(Guid userId)`: Get all where UserId matches AND RevokedAtUtc is null, set RevokedAtUtc for each, SaveChanges
    - `SaveChangesAsync()`: Delegates to `_context.SaveChangesAsync()`

    **3. Create RefreshTokenConfiguration** (`OrbitSpace.Infrastructure/Persistence/Configurations/RefreshTokenConfiguration.cs`):
    - Follow existing patterns (see UserConfiguration, GoalConfiguration for reference)
    - Token: max length 512, required
    - DeviceInfo: max length 500, optional
    - ReplacedByToken: max length 512, optional
    - Index on Token column (for lookup performance)
    - Index on UserId column
    - Index on ExpiresAtUtc (for cleanup queries)
    - Foreign key to Users table with cascade delete

    **4. Update UserConfiguration** — add:
    - DateOfBirth configuration
    - EmailVerified default value false
    - EmailVerificationToken max length 512, optional
    - CreatedAtUtc, UpdatedAtUtc columns

    **5. Update AppDbContext** — add:
    - `public DbSet<RefreshToken> RefreshTokens => Set<RefreshToken>();`

    **6. Update DependencyInjection** — register:
    - `services.AddScoped<IRefreshTokenRepository, RefreshTokenRepository>();`

    **7. Update AuthenticationService** — implement all methods:
    - **RegisterAsync**: Add DateOfBirth from request. Set CreatedAtUtc/UpdatedAtUtc = UtcNow. Set EmailVerified = false. Change password minimum from 6 to 4 (per user decision for dev phase).
    - **LoginAsync(LoginRequestDto request)**: Change parameter from separate strings to DTO. After validating credentials, generate access token via `tokenService.GenerateAccessToken(user)`, generate refresh token string via `tokenService.GenerateRefreshToken()`, hash it via `tokenService.HashToken(refreshTokenValue)`, create RefreshToken entity with hashed token in DB (expiration: 7 days if !RememberMe, 30 days if RememberMe), return `LoginResponseDto(accessToken, refreshTokenValue, userDto)` — return the UNHASHED refresh token to caller. Map user to UserDto including new fields.
    - **RefreshAsync(RefreshRequestDto request)**: Hash incoming token, look up via repository. If null or !IsActive, return Unauthorized error. Mark old token UsedAtUtc = UtcNow. Generate new access + refresh tokens. Create new RefreshToken in DB (inherit expiration strategy from old token: if old ExpiresAtUtc > UtcNow.AddDays(7) then it was "remember me"). Set old token's ReplacedByToken = new hashed token. Save changes. Return RefreshResponseDto with unhashed new tokens.
    - **RevokeAsync(RevokeRequestDto request)**: Hash token, call repository RevokeByTokenAsync. Return Success.
    - **RevokeAllAsync(Guid userId)**: Call repository RevokeAllByUserIdAsync. Return Success.
    - **Important**: Inject `IRefreshTokenRepository` alongside existing dependencies using primary constructor pattern.

    **8. Create database migration**:
    - Run: `dotnet ef migrations add AddRefreshTokensAndUpdateUsers --project OrbitSpace.Infrastructure --startup-project OrbitSpace`
    - From the `dotnet-web-api/` directory
    - This will generate migration for: new refresh_tokens table, new User columns (date_of_birth, email_verified, email_verification_token, created_at_utc, updated_at_utc)
    - Then run: `dotnet ef database update --project OrbitSpace.Infrastructure --startup-project OrbitSpace` to apply (requires PostgreSQL running via docker compose)
  </action>
  <verify>
    1. Run `dotnet build dotnet-web-api/` — entire solution must compile.
    2. Verify migration was created: check that a new migration file exists in `OrbitSpace.Infrastructure/Migrations/` with name containing `AddRefreshTokensAndUpdateUsers`.
    3. If database is available, run `dotnet ef database update --project OrbitSpace.Infrastructure --startup-project OrbitSpace` from `dotnet-web-api/` directory.
  </verify>
  <done>
    JwtTokenService generates access tokens (15min expiry) and refresh tokens (64-byte random). RefreshTokenRepository provides full CRUD. AuthenticationService handles register (with DateOfBirth), login (returns both tokens), refresh (with rotation), and revoke flows. Database migration created for refresh_tokens table and User field additions. Full solution compiles.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build dotnet-web-api/` compiles without errors
2. Migration file exists for refresh tokens table and user field changes
3. RefreshToken entity has all security properties (IsActive, IsRevoked, IsExpired)
4. Access token expiration is 15 minutes (not 7 days)
5. Refresh tokens are hashed before storage (SHA256)
6. AuthenticationService.LoginAsync returns both access and refresh tokens
7. AuthenticationService.RefreshAsync implements token rotation (marks old as used, issues new pair)
</verification>

<success_criteria>
Backend auth foundation compiles, has database migration, and implements: registration with DateOfBirth, login returning access+refresh tokens, token refresh with rotation, and token revocation. Refresh tokens are stored as SHA256 hashes. Access tokens expire in 15 minutes.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-01-SUMMARY.md`
</output>
