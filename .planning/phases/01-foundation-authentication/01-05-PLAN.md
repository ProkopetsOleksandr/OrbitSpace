---
phase: 01-foundation-authentication
plan: 05
type: execute
wave: 3
depends_on: ["01-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can register a new account at /register with email, password, name, date of birth"
    - "User can log in at /login and is redirected to dashboard"
    - "User stays logged in across browser sessions (refresh token in cookie)"
    - "JWT tokens are stored in httpOnly cookies (never visible in browser JS)"
    - "Server Components can fetch from .NET API with auth headers"
    - "Client Components can call proxy routes that forward to .NET API"
    - "Unauthenticated users are redirected to /login"
    - "Auth pages (login, register) are accessible without authentication"
  artifacts: []
  key_links: []
---

<objective>
End-to-end verification of the complete auth system. Test every flow: registration, login, protected routes, token refresh, logout. This ensures all plans integrate correctly and the phase success criteria are met.

Purpose: Individual plans can pass their own verification while integration breaks. This checkpoint catches cross-plan issues.
Output: Verified working auth system ready for Phase 2.
</objective>

<execution_context>
@C:/Users/Александр/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Александр/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-authentication/01-04-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Verify complete auth flow end-to-end</name>
  <files>none (verification only)</files>
  <action>Human verification checkpoint — no automated implementation. User manually tests the complete auth system built by Plans 01-04.</action>
  <verify>All 6 test scenarios described in how-to-verify pass without issues.</verify>
  <done>User has confirmed the complete auth flow works end-to-end: registration, login, protected routes, cookie security, auth page accessibility, and existing features.</done>
  <what-built>
    Complete JWT authentication system with BFF proxy pattern:
    - Backend: register, login (access + refresh tokens), token refresh with rotation, token revocation
    - Frontend: login page, register page, forgot-password stub, httpOnly cookie storage, custom middleware, DAL, proxy route
    - Security: defense-in-depth (middleware + DAL), tokens never exposed to browser JS, refresh token rotation, SHA256 hashed storage
  </what-built>
  <how-to-verify>
    **Prerequisites:** Both backend and frontend must be running.
    - Backend: `cd dotnet-web-api && dotnet run --project OrbitSpace` (needs PostgreSQL via docker-compose)
    - Frontend: `cd next-js-app && pnpm dev`

    **Test 1: Registration**
    1. Navigate to `http://localhost:3000/register`
    2. Verify: centered card layout, OrbitSpace branding, no dashboard sidebar
    3. Fill form: email, first name, last name, date of birth, password (min 4 chars), repeat password
    4. Submit — should redirect to dashboard (/)
    5. Verify: you are logged in (no redirect back to login)

    **Test 2: Logout and Login**
    1. If there's a logout mechanism, use it. Otherwise clear cookies manually (DevTools → Application → Cookies → delete access-token and refresh-token)
    2. Navigate to `http://localhost:3000/login`
    3. Verify: centered card layout, OrbitSpace branding, no dashboard sidebar
    4. Enter the credentials from registration
    5. Submit — should redirect to dashboard
    6. Check "Remember me" behavior: with it checked, refresh-token cookie should have a long maxAge

    **Test 3: Protected Routes**
    1. Clear all cookies
    2. Navigate to `http://localhost:3000/` (or any protected page)
    3. Verify: redirected to `/login`
    4. Log in again
    5. Navigate to protected pages — should work

    **Test 4: Cookie Security**
    1. While logged in, open browser DevTools → Console
    2. Type `document.cookie` — should NOT show access-token or refresh-token (httpOnly prevents JS access)
    3. Go to DevTools → Application → Cookies — verify both cookies exist with httpOnly flag

    **Test 5: Auth Pages Accessibility**
    1. While logged out, navigate to `/login` — page loads (no redirect loop)
    2. Navigate to `/register` — page loads
    3. Navigate to `/forgot-password` — shows "Coming soon" stub

    **Test 6: Existing Features**
    1. While logged in, verify existing features (goals, activities) still work through the proxy
    2. If they don't work, note what errors appear

    Report any issues found. Type "approved" if all tests pass, or describe specific failures.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found during testing</resume-signal>
</task>

</tasks>

<verification>
All 6 test scenarios pass:
1. Registration creates account and auto-logs in
2. Login authenticates and redirects correctly
3. Protected routes redirect unauthenticated users
4. Cookies are httpOnly (not accessible via document.cookie)
5. Auth pages work without authentication
6. Existing features work through updated proxy
</verification>

<success_criteria>
Phase 1 success criteria from ROADMAP.md are all met:
1. User can create a new account with email and password ✓
2. User can log in and stay logged in across browser sessions ✓
3. JWT tokens are stored in httpOnly cookies (never exposed to browser JS) ✓
4. Server Components can fetch from .NET API with automatic auth header injection ✓
5. Client Components can call proxy routes that forward to .NET API with cookies ✓
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-05-SUMMARY.md`
</output>
